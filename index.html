<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ความหมายไพ่ยิปซี - ใครจะเข้ามาในชีวิตคุณช่วงวาเลนไทน์</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Prompt:wght@200;300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --burgundy: #722F37;
            --cream: #FFFEF5;
            --cream-dark: #F5F0E1;
            --envelope-cream: #F8F4E8;
            --gold: #C9A227;
        }

        body {
            font-family: 'Prompt', sans-serif;
            font-weight: 300;
            background: repeating-linear-gradient(
                90deg,
                var(--cream) 0px,
                var(--cream) 8px,
                var(--cream-dark) 8px,
                var(--cream-dark) 10px
            );
            min-height: 100vh;
            color: var(--burgundy);
            overflow-x: hidden;
        }

        /* ==================== LANDING PAGE ==================== */
        .landing-heading {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            font-weight: 500;
            color: var(--burgundy);
            text-align: center;
            line-height: 1.3;
            max-width: 350px;
            padding: 0 20px;
            margin-top: 8vh;
            margin-bottom: 0;
        }

        .landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .landing-page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Spinning Card Container - Diamond shape spinning on corner */
        .spinning-card-container {
            position: relative;
            width: 180px;
            height: 321px;
            perspective: 1500px;
            cursor: pointer;
            transform-style: preserve-3d;
            margin-top: auto;
            margin-bottom: auto;
        }

        .spinning-card-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transform-origin: center center;
            /* Spin around Y-axis (vertical) */
            animation: spinOnY 3s linear infinite;
        }

        .spinning-card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transform-origin: center center;
            /* Tilt so diagonal (top-left to bottom-right) becomes vertical
               angle = arctan(width/height) = arctan(180/321) ≈ 29.3 degrees */
            transform: rotate(-29.3deg);
        }

        .spinning-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            overflow: hidden;
            box-shadow:
                0 30px 60px rgba(114, 47, 55, 0.5),
                0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .spinning-card-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spinning-card-back {
            transform: rotateY(180deg);
        }

        @keyframes spinOnY {
            0% {
                transform: rotateY(0deg);
            }
            100% {
                transform: rotateY(360deg);
            }
        }

        .spinning-card-container:hover .spinning-card-wrapper {
            animation-play-state: paused;
        }

        .spinning-card-container:hover {
            transform: scale(1.05);
        }

        /* Sparkle particles - floating stars */
        .spinning-card-container .sparkle-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 1) 0%,
                rgba(255, 215, 0, 0.8) 30%,
                transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
        }

        @keyframes sparkleRise {
            0% {
                opacity: 0;
                transform: translate(0, 0) scale(0);
            }
            20% {
                opacity: 1;
                transform: translate(calc(var(--move-x) * 0.2), calc(var(--move-y) * 0.2)) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--move-x), var(--move-y)) scale(0.5);
            }
        }

        /* Click hint on card */
        .card-click-hint {
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Prompt', sans-serif;
            font-weight: 300;
            font-size: 0.9rem;
            color: var(--burgundy);
            opacity: 0.8;
            white-space: nowrap;
        }

        /* Landing Instruction */
        .landing-instruction {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Brand on Landing */
        .landing-brand {
            position: absolute;
            bottom: 30px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            letter-spacing: 3px;
            color: var(--burgundy);
        }

        /* ==================== MAIN PAGE ==================== */
        .main-page {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease 0.5s, visibility 0.8s ease 0.5s;
        }

        .main-page.visible {
            opacity: 1;
            visibility: visible;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 15px 20px 10px;
        }

        .header-seal {
            width: 45px;
            height: 45px;
            background: var(--burgundy);
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.4);
            position: relative;
        }

        .header-seal::before {
            content: '';
            position: absolute;
            width: 35px;
            height: 35px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .header-seal-text {
            color: var(--cream);
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.45rem;
            text-align: center;
        }

        .title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-style: italic;
            color: var(--burgundy);
        }

        .subtitle {
            display: none;
        }

        .instruction {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--burgundy);
        }

        /* Card Grid - Circular Layout */
        .card-grid {
            position: relative;
            width: 100%;
            height: calc(100vh - 180px);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Card */
        .card-container {
            position: absolute;
            width: 80px;
            height: 143px;
            perspective: 1000px;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-origin: center center;
        }

        .card-container:hover {
            z-index: 1000 !important;
        }

        .card-container.disabled {
            pointer-events: none;
            opacity: 0.3;
            transform: scale(0.95);
        }

        .card-container.selecting {
            transform: translateY(-30px);
            opacity: 0;
            transition: all 0.4s ease;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.2);
        }

        .card-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-back {
            background: #FFB6C1;
        }

        .card-front {
            transform: rotateY(180deg);
            background: white;
        }


        /* Center Card (Large) */
        .center-card-container {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 280px;
            height: 500px;
            z-index: 1001;
            perspective: 1000px;
            transform: translate(-50%, -150%);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        .center-card-container.active {
            transform: translate(-50%, -70%);
            opacity: 1;
        }

        .center-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .center-card.flipped {
            transform: rotateY(180deg);
        }

        .center-card .card-face {
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Result Panel */
        .result-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--cream);
            border-top: 4px solid var(--burgundy);
            border-radius: 30px 30px 0 0;
            padding: 30px;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 45vh;
            overflow-y: auto;
        }

        .result-panel.active {
            transform: translateY(0);
        }

        .result-card-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            text-align: center;
            color: var(--burgundy);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .result-quote {
            font-family: 'Cormorant Garamond', serif;
            font-style: italic;
            font-size: 1.1rem;
            text-align: center;
            color: var(--burgundy);
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(114, 47, 55, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--burgundy);
        }

        .result-interpretation {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--burgundy);
            text-align: left;
            white-space: pre-line;
            max-width: 600px;
            margin: 0 auto;
        }

        .result-close {
            display: block;
            margin: 20px auto 0;
            padding: 12px 40px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            background: var(--burgundy);
            color: var(--cream);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-close:hover {
            background: #5a252c;
            transform: scale(1.05);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 10px 20px;
            color: var(--burgundy);
            font-family: 'Cormorant Garamond', serif;
        }

        .brand {
            font-size: 1rem;
            letter-spacing: 2px;
            opacity: 0.7;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--burgundy);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .envelope-container {
                width: 85vw;
                height: 60vw;
                max-width: none;
                max-height: none;
            }

            .wax-seal {
                width: 110px;
                height: 110px;
            }

            .wax-seal::before {
                width: 85px;
                height: 85px;
            }

            .landing-heading {
                font-size: 2.2rem;
                max-width: 300px;
                margin-top: 6vh;
            }

            .spinning-card-container {
                width: 150px;
                height: 268px;
            }

            .card-click-hint {
                font-size: 0.85rem;
                bottom: -50px;
            }

            .title {
                font-size: 1.2rem;
            }

            header {
                padding: 10px 15px 5px;
            }

            .card-grid {
                height: calc(100vh - 150px);
            }

            footer {
                padding: 5px 15px;
            }

            .center-card-container {
                width: 240px;
                height: 429px;
            }

            .result-panel {
                max-height: 50vh;
                padding: 20px;
            }

            .result-card-name {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .envelope-container {
                width: 90vw;
                height: 63vw;
            }

            .wax-seal {
                width: 95px;
                height: 95px;
            }

            .wax-seal::before {
                width: 72px;
                height: 72px;
            }

            .landing-heading {
                font-size: 2.3rem;
                max-width: 280px;
                margin-top: 8vh;
            }

            .spinning-card-container {
                width: 180px;
                height: 321px;
            }

            .card-click-hint {
                font-size: 0.8rem;
                bottom: -50px;
            }

            header {
                padding: 8px 10px 3px;
            }

            .header-seal {
                width: 35px;
                height: 35px;
                margin-bottom: 5px;
            }

            .header-seal::before {
                width: 28px;
                height: 28px;
            }

            .title {
                font-size: 1rem;
            }

            .instruction {
                font-size: 0.8rem;
                margin-top: 5px;
            }

            .card-grid {
                height: calc(100vh - 120px);
            }

            footer {
                padding: 5px 10px;
            }

            .brand {
                font-size: 0.85rem;
            }

            .center-card-container {
                width: 200px;
                height: 357px;
            }
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <div class="landing-page" id="landingPage">
        <h1 class="landing-heading">Who's Gonna Be My Next Mistake?</h1>
        <div class="spinning-card-container" id="spinningCardContainer">
            <div class="spinning-card-wrapper">
                <div class="spinning-card" id="spinningCard">
                    <div class="spinning-card-face spinning-card-front">
                        <img id="spinningCardFront" src="images/tarot/THE LOVERS.png" alt="Tarot Card Front">
                    </div>
                    <div class="spinning-card-face spinning-card-back">
                        <img src="images/card_back_red.png" alt="Card Back">
                    </div>
                </div>
            </div>
            <span class="card-click-hint">แตะไพ่เพื่อเริ่มดูดวง</span>
        </div>
        <p class="landing-instruction">ใครจะเข้ามาในชีวิตคุณช่วงวาเลนไทน์?</p>
        <p class="landing-brand">TIONNA B | Yf</p>
    </div>

    <!-- Main Page -->
    <div class="main-page" id="mainPage">
        <div class="container">
            <header>
                <div class="header-seal">
                    <span class="header-seal-text">Valentine<br>Tarot</span>
                </div>
                <h1 class="title">ใครจะเข้ามาในชีวิตคุณช่วงวาเลนไทน์</h1>
                <p class="subtitle">"The Tastemaker Dictionary for Curation"</p>
                <p class="instruction">เลือกไพ่ 1 ใบ เพื่อดูคำทำนาย</p>
            </header>

            <div class="card-grid" id="cardGrid">
                <div class="loading">กำลังโหลดไพ่...</div>
            </div>

            <footer>
                <p class="brand">TIONNA B | Yf</p>
            </footer>
        </div>
    </div>

    <!-- Flash Overlay -->
    <div class="flash-overlay" id="flashOverlay"></div>

    <!-- Card Burst Container -->
    <div class="card-burst-container" id="cardBurstContainer"></div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Center Card (Large) -->
    <div class="center-card-container" id="centerCard">
        <div class="center-card" id="centerCardInner">
            <div class="card-face card-back">
                <img src="images/card_back_red.png" alt="Card Back">
            </div>
            <div class="card-face card-front">
                <img id="centerCardImage" src="" alt="Card">
            </div>
        </div>
    </div>

    <!-- Result Panel -->
    <div class="result-panel" id="resultPanel">
        <h3 class="result-card-name" id="resultCardName"></h3>
        <p class="result-quote" id="resultQuote"></p>
        <p class="result-interpretation" id="resultInterpretation"></p>
        <button class="result-close" id="resultClose">เลือกไพ่ใหม่</button>
    </div>

    <script>
        let tarotData = null;
        let selectedCardElement = null;
        let isAnimating = false;

        // Card images for spinning display
        const spinningCardImages = [
            'images/tarot/THE LOVERS.png',
            'images/tarot/THE STAR.png',
            'images/tarot/THE SUN.png',
            'images/tarot/THE MOON.png',
            'images/tarot/THE EMPRESS.png',
            'images/tarot/THE EMPEROR.png',
            'images/tarot/WHEEL OF FORTUNE.png',
            'images/tarot/THE MAGICIAN.png',
            'images/tarot/THE HIGH PRIESTRESS.png',
            'images/tarot/STRENGTH.png'
        ];

        let currentSpinningCardIndex = 0;
        let spinningCardInterval = null;

        // Change the front card image during rotation
        function startCardRotation() {
            const frontImg = document.getElementById('spinningCardFront');

            // Wait 1.5s (when back is facing) then change image every 3s (full rotation)
            // This ensures image changes when back is facing, not when front is visible
            setTimeout(() => {
                // First change at 1.5s (back facing)
                currentSpinningCardIndex = (currentSpinningCardIndex + 1) % spinningCardImages.length;
                frontImg.src = spinningCardImages[currentSpinningCardIndex];

                // Then change every 3s (one full rotation, always when back is facing)
                spinningCardInterval = setInterval(() => {
                    currentSpinningCardIndex = (currentSpinningCardIndex + 1) % spinningCardImages.length;
                    frontImg.src = spinningCardImages[currentSpinningCardIndex];
                }, 3000);
            }, 1500);
        }

        // Create floating sparkles around spinning card
        let sparkleInterval = null;
        function createFloatingSparkles() {
            const container = document.getElementById('spinningCardContainer');

            sparkleInterval = setInterval(() => {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle-particle';

                // Random position in a circle around the center
                const angle = Math.random() * Math.PI * 2;
                const radius = 100 + Math.random() * 60;
                const x = 90 + Math.cos(angle) * radius;
                const y = 160 + Math.sin(angle) * radius;

                // Random movement direction
                const moveX = (Math.random() - 0.5) * 40;
                const moveY = -20 - Math.random() * 30; // Float upward
                const duration = 1.5 + Math.random() * 1;
                const size = 3 + Math.random() * 5;

                sparkle.style.cssText = `
                    left: ${x}px;
                    top: ${y}px;
                    width: ${size}px;
                    height: ${size}px;
                    animation: sparkleRise ${duration}s ease-out forwards;
                    --move-x: ${moveX}px;
                    --move-y: ${moveY}px;
                `;

                container.appendChild(sparkle);

                // Remove after animation
                setTimeout(() => sparkle.remove(), duration * 1000);
            }, 200);
        }

        function stopFloatingSparkles() {
            if (sparkleInterval) {
                clearInterval(sparkleInterval);
                sparkleInterval = null;
            }
        }

        // Create sparkles
        function createSparkles(centerX, centerY) {
            const container = document.getElementById('cardBurstContainer');

            for (let i = 0; i < 25; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';

                const angle = Math.random() * Math.PI * 2;
                const distance = 150 + Math.random() * 250;
                const sx = Math.cos(angle) * distance;
                const sy = Math.sin(angle) * distance - 100;

                sparkle.style.cssText = `
                    left: ${centerX}px;
                    top: ${centerY}px;
                    --sx: ${sx}px;
                    --sy: ${sy}px;
                    animation-delay: ${Math.random() * 300}ms;
                    width: ${4 + Math.random() * 8}px;
                    height: ${4 + Math.random() * 8}px;
                `;

                container.appendChild(sparkle);

                setTimeout(() => {
                    sparkle.classList.add('animate');
                }, Math.random() * 300);
            }
        }

        // Create flying cards burst effect
        function createCardBurst() {
            const container = document.getElementById('cardBurstContainer');
            const flashOverlay = document.getElementById('flashOverlay');
            const cardRect = document.getElementById('spinningCardContainer').getBoundingClientRect();
            const centerX = cardRect.left + cardRect.width / 2;
            const centerY = cardRect.top + cardRect.height / 2;

            // Trigger flash effect
            flashOverlay.classList.add('active');
            setTimeout(() => {
                flashOverlay.classList.remove('active');
            }, 600);

            // Create sparkles
            createSparkles(centerX, centerY);

            // Create 14 flying cards
            for (let i = 0; i < 14; i++) {
                const card = document.createElement('div');
                card.className = 'flying-card';

                // Alternate between card back and front
                const imgSrc = i % 2 === 0 ? 'images/card_back_red.png' : spinningCardImages[i % spinningCardImages.length];
                card.innerHTML = `<img src="${imgSrc}" alt="Flying Card">`;

                // Random direction for burst effect
                const angle = (i / 14) * Math.PI * 2 + (Math.random() - 0.5) * 0.5;
                const distance = 180 + Math.random() * 120;
                const endDistance = 500 + Math.random() * 350;

                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                const txEnd = Math.cos(angle) * endDistance;
                const tyEnd = Math.sin(angle) * endDistance - 200;
                const rot = (Math.random() - 0.5) * 60;
                const rotEnd = rot + (Math.random() - 0.5) * 180;

                card.style.cssText = `
                    left: ${centerX}px;
                    top: ${centerY}px;
                    --tx: ${tx}px;
                    --ty: ${ty}px;
                    --tx-end: ${txEnd}px;
                    --ty-end: ${tyEnd}px;
                    --rot: ${rot}deg;
                    --rot-end: ${rotEnd}deg;
                    animation-delay: ${i * 40}ms;
                `;

                container.appendChild(card);

                setTimeout(() => {
                    card.classList.add('animate');
                }, 10 + i * 40);
            }

            // Clean up after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 2000);
        }

        // Start the experience (when card is clicked)
        function startExperience() {
            const spinningCard = document.getElementById('spinningCard');
            const landingPage = document.getElementById('landingPage');
            const mainPage = document.getElementById('mainPage');

            // Stop the rotation interval and sparkles
            if (spinningCardInterval) {
                clearInterval(spinningCardInterval);
            }
            stopFloatingSparkles();

            // Stop the spinning animation and fly away
            spinningCard.style.animation = 'none';
            spinningCard.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            spinningCard.style.transform = 'rotateY(0deg) scale(1.2)';

            // Trigger card burst effect
            setTimeout(() => {
                createCardBurst();
                spinningCard.style.transform = 'rotateY(0deg) scale(0) translateY(-100px)';
                spinningCard.style.opacity = '0';
            }, 300);

            // Transition to main page
            setTimeout(() => {
                landingPage.classList.add('hidden');
                mainPage.classList.add('visible');

                // Trigger card fan animation
                setTimeout(() => {
                    animateToEllipse();
                }, 1300);
            }, 800);
        }

        // Load tarot data
        async function loadTarotData() {
            try {
                const response = await fetch('valentine_tarot.json');
                tarotData = await response.json();
                renderCards();
            } catch (error) {
                console.error('Error loading tarot data:', error);
                document.getElementById('cardGrid').innerHTML =
                    '<p class="loading">ไม่สามารถโหลดข้อมูลไพ่ได้</p>';
            }
        }

        // Shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Expand cards to 78
        function expandCardsTo78(cards) {
            const targetCount = 78;
            const baseCount = cards.length; // 22
            const timesEach = Math.floor(targetCount / baseCount); // 3
            const remainder = targetCount % baseCount; // 12

            let expanded = [];

            // Add each card 'timesEach' times (3 times each = 66 cards)
            for (let i = 0; i < timesEach; i++) {
                expanded = expanded.concat(cards);
            }

            // Add 'remainder' more cards randomly (12 more to reach 78)
            const shuffledForExtra = shuffleArray([...cards]);
            for (let i = 0; i < remainder; i++) {
                expanded.push(shuffledForExtra[i]);
            }

            return expanded;
        }

        // Render cards
        function renderCards() {
            const cardGrid = document.getElementById('cardGrid');
            const expandedCards = expandCardsTo78(tarotData.cards);
            const shuffledCards = shuffleArray(expandedCards);

            cardGrid.innerHTML = shuffledCards.map((card, index) => `
                <div class="card-container" data-card-id="${card.id}">
                    <div class="card">
                        <div class="card-face card-back">
                            <img src="images/card_back_red.png" alt="Card Back">
                        </div>
                        <div class="card-face card-front">
                            <img src="images/tarot/${card.image}" alt="${card.name}">
                        </div>
                    </div>
                </div>
            `).join('');

            // Add click listeners and hover effects
            document.querySelectorAll('.card-container').forEach((container, index) => {
                container.addEventListener('click', () => {
                    const cardId = parseInt(container.dataset.cardId);
                    selectCard(cardId, container);
                });

                // Store original transform for hover effects
                container.dataset.index = index;

                container.addEventListener('mouseenter', () => {
                    if (!container.classList.contains('selecting') && !container.classList.contains('disabled')) {
                        const originalTransform = getCardTransform(index);
                        container.style.transform = `${originalTransform} scale(1.4)`;
                        container.style.zIndex = '1000';
                    }
                });

                container.addEventListener('mouseleave', () => {
                    if (!container.classList.contains('selecting') && !container.classList.contains('disabled')) {
                        const originalTransform = getCardTransform(index);
                        container.style.transform = originalTransform;
                        container.style.zIndex = index;
                    }
                });
            });

            // Apply stacked layout initially (animation triggered later)
            applyStackedLayout();
        }

        // Apply stacked layout (initial state)
        function applyStackedLayout() {
            const containers = document.querySelectorAll('.card-container');
            const { cardWidth, cardHeight } = getEllipseParams();

            containers.forEach((container, index) => {
                // Small random offset for natural stack look
                const offsetX = (Math.random() - 0.5) * 8;
                const offsetY = (Math.random() - 0.5) * 4;
                const rotation = (Math.random() - 0.5) * 10;

                container.style.width = `${cardWidth}px`;
                container.style.height = `${cardHeight}px`;
                container.style.left = `calc(50% - ${cardWidth/2}px + ${offsetX}px)`;
                container.style.top = `calc(50% - ${cardHeight/2}px + ${offsetY}px)`;
                container.style.transform = `rotate(${rotation}deg)`;
                container.style.zIndex = index;
                container.style.transition = 'none';
            });
        }

        // Animate cards from stack to ellipse
        function animateToEllipse() {
            const containers = document.querySelectorAll('.card-container');
            const totalCards = containers.length;
            const { radiusX, radiusY, cardWidth, cardHeight, offsetY } = getEllipseParams();

            containers.forEach((container, index) => {
                // Stagger the animation
                const delay = index * 15;

                setTimeout(() => {
                    container.style.transition = 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';

                    const anglePerCard = (2 * Math.PI) / totalCards;
                    const angle = index * anglePerCard - Math.PI / 2;

                    const x = radiusX * Math.cos(angle);
                    const y = radiusY * Math.sin(angle) + offsetY;
                    const rotationDeg = (angle * 180 / Math.PI) + 90;

                    container.style.left = `calc(50% + ${x}px - ${cardWidth/2}px)`;
                    container.style.top = `calc(50% + ${y}px - ${cardHeight/2}px)`;
                    container.style.transform = `rotate(${rotationDeg}deg)`;
                    container.style.zIndex = index;

                    // Reset transition after animation
                    setTimeout(() => {
                        container.style.transition = 'all 0.3s ease';
                    }, 600);
                }, delay);
            });
        }

        // Get responsive elliptical parameters
        function getEllipseParams() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            if (width <= 480) {
                // Mobile: tall ellipse along screen height
                return {
                    radiusX: Math.min(width * 0.38, 150),   // Narrow horizontal
                    radiusY: Math.min(height * 0.32, 220),  // Tall vertical
                    cardWidth: 40,
                    cardHeight: 71,
                    offsetY: 0
                };
            } else if (width <= 768) {
                return {
                    radiusX: 160,   // Narrow
                    radiusY: 280,   // Tall
                    cardWidth: 50,
                    cardHeight: 89,
                    offsetY: 0
                };
            }
            return {
                radiusX: 200,   // Narrow
                radiusY: 380,   // Very tall
                cardWidth: 65,
                cardHeight: 116,
                offsetY: 0
            };
        }

        // Get card transform based on index for elliptical layout
        function getCardTransform(index) {
            const totalCards = 78;
            const anglePerCard = (2 * Math.PI) / totalCards;
            const angle = index * anglePerCard - Math.PI / 2; // Start from top
            const rotationDeg = (angle * 180 / Math.PI) + 90; // Point outward
            return `rotate(${rotationDeg}deg)`;
        }

        // Apply elliptical layout
        function applyCircularLayout() {
            const containers = document.querySelectorAll('.card-container');
            const totalCards = containers.length;
            const { radiusX, radiusY, cardWidth, cardHeight, offsetY } = getEllipseParams();

            containers.forEach((container, index) => {
                const anglePerCard = (2 * Math.PI) / totalCards;
                const angle = index * anglePerCard - Math.PI / 2; // Start from top

                // Calculate position on ellipse
                const x = radiusX * Math.cos(angle);
                const y = radiusY * Math.sin(angle) + offsetY;

                // Rotation to point outward from center
                const rotationDeg = (angle * 180 / Math.PI) + 90;

                container.style.width = `${cardWidth}px`;
                container.style.height = `${cardHeight}px`;
                container.style.left = `calc(50% + ${x}px - ${cardWidth/2}px)`;
                container.style.top = `calc(50% + ${y}px - ${cardHeight/2}px)`;
                container.style.transformOrigin = 'center center';
                container.style.transform = `rotate(${rotationDeg}deg)`;
                container.style.zIndex = index;
            });
        }

        // Select card
        function selectCard(cardId, cardElement) {
            if (isAnimating) return;
            isAnimating = true;

            const card = tarotData.cards.find(c => c.id === cardId);
            if (!card) {
                isAnimating = false;
                return;
            }

            selectedCardElement = cardElement;

            // Set center card image
            document.getElementById('centerCardImage').src = `images/tarot/${card.image}`;

            // Reset center card flip state
            document.getElementById('centerCardInner').classList.remove('flipped');

            // Step 1: Selected card slides up and fades out
            cardElement.classList.add('selecting');

            // Disable other cards
            document.querySelectorAll('.card-container').forEach(c => {
                if (c !== cardElement) {
                    c.classList.add('disabled');
                }
            });

            // Step 2: Show overlay and center card slides down
            setTimeout(() => {
                document.getElementById('overlay').classList.add('active');
                document.getElementById('centerCard').classList.add('active');

                // Step 3: Flip center card
                setTimeout(() => {
                    document.getElementById('centerCardInner').classList.add('flipped');

                    // Step 4: Show result panel
                    setTimeout(() => {
                        document.getElementById('resultCardName').textContent = card.name;
                        document.getElementById('resultQuote').textContent = `"${card.quote}"`;
                        document.getElementById('resultInterpretation').textContent = card.interpretation;
                        document.getElementById('resultPanel').classList.add('active');
                        isAnimating = false;
                    }, 800);
                }, 500);
            }, 400);
        }

        // Close and reset
        function closeResult() {
            if (isAnimating) return;
            isAnimating = true;

            // Hide result panel
            document.getElementById('resultPanel').classList.remove('active');

            setTimeout(() => {
                // Hide center card
                document.getElementById('centerCard').classList.remove('active');

                // Hide overlay
                document.getElementById('overlay').classList.remove('active');

                // Reshuffle and re-render
                setTimeout(() => {
                    renderCards();
                    selectedCardElement = null;
                    isAnimating = false;

                    // Animate cards from stack to fan
                    setTimeout(() => {
                        animateToEllipse();
                    }, 100);
                }, 400);
            }, 300);
        }

        // Event listeners
        document.getElementById('spinningCardContainer').addEventListener('click', startExperience);
        document.getElementById('resultClose').addEventListener('click', closeResult);
        document.getElementById('overlay').addEventListener('click', closeResult);

        // Start card rotation and sparkles on page load
        startCardRotation();
        createFloatingSparkles();

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeResult();
            }
            if (e.key === 'Enter' || e.key === ' ') {
                const landingPage = document.getElementById('landingPage');
                if (!landingPage.classList.contains('hidden')) {
                    startExperience();
                }
            }
        });

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                applyCircularLayout();
            }, 100);
        });

        // Initialize
        loadTarotData();
    </script>
</body>
</html>
